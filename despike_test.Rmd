---
title: "Clean data with despike"
author: "Jean-Pierre Gattuso"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  rmarkdown::html_document:
    theme: paper
    number_sections: false
theme: cerulean
---

```{r setup and prepare data, include=FALSE}
rm(list = ls())
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse")
if (!require("lubridate")) install.packages("lubridate")
library("lubridate")
if (!require("oce")) install.packages("oce")
library(oce)
if (!require("dygraphs")) install.packages("dygraphs")
library(dygraphs)
if (!require("tidyverse")) install.packages("tidyverse")
library(xts)
if (!require("curl")) install.packages("curl")
library(curl)
if (!require("readxl")) install.packages("readxl")
library(readxl)
if (!require("data.table")) install.packages("data.table")
library(data.table)
if (!require("tsibble")) install.packages("tsibble")
library(tsibble)
if (!require("cowplot")) install.packages("cowplot")
library(cowplot)
if (!require("plotly")) install.packages("plotly")
library(plotly)
if (!require("htmlwidgets")) install.packages("htmlwidgets")
library(htmlwidgets)
if (!require("xts")) install.packages("xts")
if (!require("stringr")) install.packages("stringr")
library(stringr)
if (!require("devtools")) install.packages("devtools")
library(devtools)
if (!require("feasts")) install.packages("feasts")
library(feasts)
if (!require("knitr")) install.packages("knitr")
library(knitr)
if (!require("kableExtra")) install.packages("kableExtra")
library(kableExtra)
if (!require("ragg")) install.packages("ragg")
library("ragg")

####define who is the user and define path
rm(list = ls())

if (Sys.getenv("LOGNAME") == "gattuso") path = "../../pCloud\ Sync/Documents/experiments/exp168_AWIPEV-CO2/fb_awipev-co2_server/ny-alesund/data/NRT_data/"
if (Sys.getenv("LOGNAME") == "samir") path = "../../pCloud\ Sync/exp168_AWIPEV-CO2/fb_awipev-co2_server/ny-alesund/data/NRT_data/"

####Set environmental variables####
Sys.setenv(TZ="UTC")
tmp <- as_tibble(
  readRDS(file = paste0(path, "all_parameters_nydata_minute.rds"))
)
data <- tmp # backup
```

```{r First cleaning, echo=FALSE}
##### First cleaning
# Argo qflags: 1 is good data, 4 is bad data

#### Argo impossible date test
data <- data %>%
  dplyr::mutate(dt_qf = ifelse(
    year(data$datetime) < 2010 | year(data$datetime) > 2022 |
      month(data$datetime) < 1 | month(data$datetime) > 12 |
      day(data$datetime) < 1 | day(data$datetime) > 31 |
      hour(data$datetime) < 0 | hour(data$datetime) > 23 |
      minute(data$datetime) < 0 | minute(data$datetime) > 59,
    4, 1)) %>%
  dplyr::filter(dt_qf == 1) # removes rows with wrong dates


## pCO2 
# Argo Global Range Test. If QF = 4 replace value by NA
# Removing outliers due to acid flush in the FB at 12:00 and 00:00 
# pco2_raw = Raw data from the sensor
# pco2_corr = Final corrected data from Contros "data processing document"

data <- data %>% 
  dplyr::mutate(
    pco2_raw_qf = ifelse(
      State_Zero >= 1 | State_Flush >= 1 |
        pco2_raw < 100 | pco2_raw > 450 |
        Time >= "00:00:00" & Time <= "01:30:00" |
        Time >= "12:00:00" & Time <= "13:00:00" |
      datetime >= "2017-03-10 08:00:00" &
        datetime < "2017-03-21 20:00:00",
      4,
      1
    ),
    pco2_raw = ifelse(pco2_raw_qf == 4 , NA, pco2_raw),
    pco2_corr_qf = ifelse(
      State_Zero >= 1 | State_Flush >= 1 |
        pco2_corr < 100 | pco2_corr > 450 |
        Time >= "00:00:00" & Time <= "01:30:00" |
        Time >= "12:00:00" & Time <= "13:00:00" |
      datetime >= "2017-03-10 08:00:00" &
        datetime < "2017-03-21 20:00:00",
      4,
      1
    ),
    pco2_corr = ifelse(pco2_corr_qf == 4 , NA, pco2_corr)
    )

## filter salinities above 28
data <- data %>%
  dplyr::mutate( sal_fb = ifelse(sal_fb < 28 | sal_fb > 36, NA, sal_fb),
                 sal_insitu_ctd = ifelse(sal_insitu_ctd < 28 | sal_fb > 36, NA, sal_insitu_ctd))
 data <- data %>%
  dplyr::mutate(sal_insitu_ctd = ifelse(datetime > "2019-12-26 00:00:00", NA, sal_insitu_ctd))

 ## filter temperatures above 10
data <- data %>%
  dplyr::mutate( temp_dur = ifelse(temp_dur > 10 | temp_dur < -2 , NA, temp_dur),
                 temp_fb = ifelse(temp_fb > 10 | temp_fb < -2 , NA, temp_fb),
                 temp_insitu_11m = ifelse(temp_insitu_11m > 10 | temp_insitu_11m < -2 , NA, temp_insitu_11m))

## seaFET
data <- data %>%
  dplyr::mutate(phINT = ifelse(phINT >7.5  & phINT <8.5, phINT, NA), 
                phEXT = ifelse(phEXT >7.5  & phEXT <8.5, phEXT, NA))

```

# {.tabset .tabset-fade .tabset-pills}

## Infos 

One reads data from the NRT and then focus on pCO2:

* Argo impossible date text

* Argo Global Range Test: eliminate pCO2 < 100 and > 450, between 00:00 and 01:30, between 12:00 to 13:00, and during periods we know the system behaved poorly.

* Use of despike:
    + The type of reference time series to be used in the detection of spikes is **median**. The first step is to linearly interpolate across any gaps (spots where x==NA), using approx() with rule=2. The second step is to pass this through runmed() to get a running median spanning k elements. The result of these two steps is the "reference" time-series. Then, the standard deviation of the difference between x and the reference is calculated. Any x values that differ from the reference by more than n times this standard deviation are considered to be spikes. If replace="reference", the spike values are replaced with the reference, and the resultant time series is returned. If replace="NA", the spikes are replaced with NA, and that result is returned.
    + all combinations of the following n and k values:
        * n <- c(0.01, 0.1, 1, 2) # number of times sd
        * k <- c(5, 31, 121, 1441, $1440*4+1$, $1440*6+1$) # time window in min

There are `r length(data$pco2_corr)` data in this 2016 file. `r sum(!is.na(data$pco2_corr))` are not NAs (the first 2 months or so have NAs). 

TO DO in RMD: 
(ph seafet dans Rmd)
(pH durafet dans Rmd)

```{r function clean, echo=FALSE, results = 'asis'}
clean <- function(var=var) {
  n <- c(0.5, 1, 2) # number of times sd
  k <-
    c(5, 31, 121, 1441, 1440 * 4 + 1, 1440 * 6 + 1) # time window to calculate median in min
  grid <- as_tibble(expand.grid(n = n, k = k)) %>%
    dplyr::arrange(n)
  res <- tibble(datetime = data$datetime)
  NAs <- NULL
  param <- NULL
  #summ <- tibble(.rows = 20)
  for (i in 1:nrow(grid)) {
    #  i <- 1
    tmp <- oce::despike(
      x = var,
      reference = "median",
      n = grid$n[i],
      k = grid$k[i],
      min = NA,
      max = NA,
      replace = "NA"
    )
    new_col_name <- paste0("n", grid$n[i], "k", grid$k[i])
    res <- dplyr::mutate(res,!!new_col_name := tmp)
    param <- append(param, new_col_name) # list of new columns
    NAs <-
      append(NAs, sum(is.na(tmp))) # number of NAs in each cleaned column
  }
  nNAs <- tibble(param = factor(param, levels = param), NAs) %>%
    dplyr::mutate(additional_NAs = NAs - sum(is.na(var)))
return(list(res=res, nNAs = nNAs))
}
``` 

```{r function plot despike, include=FALSE}
plot_despike <- function(data = res, var=var){ # car is the variable name, a text
  # d <- res %>%
#   select(datetime, starts_with("n0.1")) %>%
#   pivot_longer(-datetime, names_to = "params", values_to = "values") %>%
#   dplyr::mutate(params = factor(params)) %>%
#   dplyr::mutate(params = factor(params, levels=levels(params)[c(4, 3, 1, 2, 5, 6)]))
# plt_n0.1 <- d %>%
#   ggplot() +
#   geom_point(aes(x=datetime, y=values, col=params), na.rm= TRUE, size=0.25) +
#   facet_wrap(vars(params), ncol = 1) +
#   theme_bw()
# ggsave(filename = paste0(var,"_plt_n0.1.png"), plt_n0.1, dpi=80)
# print(plt_n0.1)

d <- res %>%
  select(datetime, starts_with("n0.5")) %>%
  pivot_longer(-datetime, names_to = "params", values_to = "values") %>%
  dplyr::mutate(params = factor(params)) %>%
  dplyr::mutate(params = factor(params, levels=levels(params)[c(4, 3, 1, 2, 5, 6)]))
plt_n0.5 <- d %>%
  ggplot() +
  geom_point(aes(x=datetime, y=values, col=params), na.rm= TRUE, size=0.25) +
  facet_wrap(vars(params), ncol = 1) +
  theme_bw()
ggsave(filename = paste0(var,"_plt_n0.5.png"), plt_n0.5, dpi=150)
print(plt_n0.5)

d <- res %>%
  select(datetime, starts_with("n1")) %>%
  pivot_longer(-datetime, names_to = "params", values_to = "values") %>%
  dplyr::mutate(params = factor(params)) %>%
  dplyr::mutate(params = factor(params, levels=levels(params)[c(4, 3, 1, 2, 5, 6)]))
plt_n1 <- d %>%
  ggplot() +
  geom_point(aes(x=datetime, y=values, col=params), na.rm= TRUE, size=0.25) +
  facet_wrap(vars(params), ncol = 1) +
  theme_bw()
ggsave(filename = paste0(var,"_plt_n1.png"), plt_n1, dpi=150)
print(plt_n1)

d <- res %>%
  select(datetime, starts_with("n2")) %>%
  pivot_longer(-datetime, names_to = "params", values_to = "values") %>%
  dplyr::mutate(params = factor(params)) %>%
  dplyr::mutate(params = factor(params, levels=levels(params)[c(4, 3, 1, 2, 5, 6)]))
plt_n2 <- d %>%
  ggplot() +
  geom_point(aes(x=datetime, y=values, col=params), na.rm= TRUE, size=0.25) +
  facet_wrap(vars(params), ncol = 1) +
  theme_bw()
ggsave(filename = paste0(var,"_plt_n2.png"), plt_n2, dpi=150)
print(plt_n2)
}
```

```{r function hour format, include=FALSE}
agg_hour <- function(data = res, var=var){
d <- as_tsibble(res %>%
                  dplyr::select(datetime, n0.5k5761, n0.5k8641, n1k5761, n1k8641, n2k5761, n2k8641))
d_hour <- d %>%
  group_by_key() %>%
  index_by(hour = ~ lubridate::floor_date(., "1 hour")) %>% # monthly aggregates
  summarise(
    n0.5k5761h = mean(n0.5k5761, na.rm = TRUE),
    n0.5k8641h = mean(n0.5k8641, na.rm = TRUE),
    n1k5761h = mean(n1k5761, na.rm = TRUE),
    n1k8641h = mean(n1k8641, na.rm = TRUE),
    n2k5761h = mean(n2k5761, na.rm = TRUE),
    n2k8641h = mean(n2k8641, na.rm = TRUE)
  )
summary_d_hour <- summary(d_hour)
return(list(d_hour=d_hour, summary_d_hour = summary_d_hour))
}
```

```{r function plot dygraphs, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike <- function(df=d, var=var){
  v <- df[[var]]
  d_hour_xts <- d_hour %>%
  as.xts(order.by = d_hour$hour)
dygraph(d_hour_xts,
        group = "",
        main = var,
        ylab = var) %>%
  dySeries(
    "n0.5k5761h",
    label = "n0.5k5761h",
    color = "black",
    strokeWidth = 0,
    pointSize = 2
  ) %>%
  dySeries(
    "n0.5k8641h",
    label = "n0.5k8641h",
    color = "red",
    strokeWidth = 0,
    pointSize = 2
  ) %>%
  dySeries(
    "n1k5761h",
    label = "n1k5761h",
    color = "blue",
    strokeWidth = 0,
    pointSize = 2
  ) %>%
  dySeries(
    "n1k8641h",
    label = "n1k8641h",
    color = "orange",
    strokeWidth = 0,
    pointSize = 2
  ) %>%
  dySeries(
    "n2k5761h",
    label = "n2k5761h",
    color = "green",
    strokeWidth = 0,
    pointSize = 2
  ) %>%
  dySeries(
    "n2k8641h",
    label = "n2k8641h",
    color = "purple",
    strokeWidth = 0,
    pointSize = 2
  ) %>%
  dyAxis("y", valueRange = 1.1*range(v, na.rm = TRUE)) %>%
  dyLimit(0, color = "black", strokePattern = "dashed") %>%
  dyHighlight(
    highlightCircleSize = 8,
    highlightSeriesBackgroundAlpha = 0.2,
    hideOnMouseOut = TRUE
  ) %>%
  dyOptions(
    useDataTimezone = TRUE,
    drawGrid = TRUE,
    drawPoints = TRUE,
    strokeWidth = 0,
    digitsAfterDecimal = 5
  ) %>%
  dyRangeSelector(height = 30)
}
```



## *p*CO~2~


### pco2_corr

```{r clean pco2_corr, echo=FALSE, results = 'asis'}
tmp <- clean(data$pco2_corr)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike pco2_corr, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$pco2_corr")
``` 

#### Hour format
```{r hour format pco2_corr, include=FALSE}
tmp <- agg_hour(data = res, var = "data$pco2_corr")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs pco2_corr, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(df=data, var="pco2_corr")
```

n0.5k5761	and n0.5k8641	remove a lot of data points (> 300,000), many of them seem legitimate. n1k5761	and n1k8641 remove much less data points (124000 to 134000) and therefore seem more appropriate. Although very subjective, it seems that n1k8641 cuts some spikes, which appears unnecessary. One settles for **n2k5761**.

## Salinities

### sal_fb

#### Cleaning 
```{r clean sal_fb, echo=FALSE, results = 'asis'}
tmp <- clean(data$sal_fb)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike sal_fb, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$sal_fb")
``` 

#### Hour format
```{r hour format sal_fb, include=FALSE}
tmp <- agg_hour(data = res, var = "data$sal_fb")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs sal_fb, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(df=data, var="sal_fb")
```
One keeps **n2k5761** which adds less NAs and seems satisfactory.

## Temperatures

### temp_fb

#### Cleaning 
```{r clean temp_fb, echo=FALSE, results = 'asis'}
tmp <- clean(data$temp_fb)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike temp_fb, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$temp_fb")
``` 

#### Hour format
```{r hour format temp_fb, include=FALSE}
tmp <- agg_hour(data = res, var = "data$temp_fb")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs temp_fb, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(df=data, var="temp_fb")
```

One keeps **n2k5761** which adds less NAs and seems satisfactory.


### temp_dur (durafet)

#### Cleaning  
```{r clean temp_dur, echo=FALSE, results = 'asis'}
tmp <- clean(data$temp_dur)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike temp_dur, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$temp_dur")
``` 

#### Hour format
```{r hour format temp_dur, include=FALSE}
tmp <- agg_hour(data = res, var = "data$temp_dur")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs temp_dur, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(df=data, var="temp_dur")
```

One keeps **n2k5761** which adds less NAs and seems satisfactory.

### temp_insitu_11m

#### Cleaning 
```{r clean temp_insitu_11m, echo=FALSE, results = 'asis'}
tmp <- clean(data$temp_insitu_11m)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike temp_insitu_11m, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$temp_insitu_11m")
``` 

#### Hour format
```{r hour format temp_insitu_11m, include=FALSE}
tmp <- agg_hour(data = res, var = "data$temp_insitu_11m")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs temp_insitu_11m, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(df=data, var="temp_insitu_11m")
```

One keeps **n2k5761** which adds less NAs and seems satisfactory.