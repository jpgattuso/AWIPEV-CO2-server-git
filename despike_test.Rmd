---
title: "Clean data with despike"
author: "Jean-Pierre Gattuso"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  rmarkdown::html_document:
    theme: paper
    number_sections: false
theme: cerulean
---

```{r setup and prepare data, include=FALSE}
rm(list = ls())
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse")
if (!require("lubridate")) install.packages("lubridate")
library("lubridate")
if (!require("oce")) install.packages("oce")
library(oce)
if (!require("dygraphs")) install.packages("dygraphs")
library(dygraphs)
if (!require("tidyverse")) install.packages("tidyverse")
library(xts)
if (!require("curl")) install.packages("curl")
library(curl)
if (!require("readxl")) install.packages("readxl")
library(readxl)
if (!require("data.table")) install.packages("data.table")
library(data.table)
if (!require("tsibble")) install.packages("tsibble")
library(tsibble)
if (!require("cowplot")) install.packages("cowplot")
library(cowplot)
if (!require("plotly")) install.packages("plotly")
library(plotly)
if (!require("htmlwidgets")) install.packages("htmlwidgets")
library(htmlwidgets)
if (!require("xts")) install.packages("xts")
if (!require("stringr")) install.packages("stringr")
library(stringr)
if (!require("devtools")) install.packages("devtools")
library(devtools)
if (!require("feasts")) install.packages("feasts")
library(feasts)
if (!require("knitr")) install.packages("knitr")
library(knitr)
if (!require("kableExtra")) install.packages("kableExtra")
library(kableExtra)

####define who is the user and define path
rm(list = ls())

if (Sys.getenv("LOGNAME") == "gattuso") path = "../../pCloud\ Sync/Documents/experiments/exp168_AWIPEV-CO2/fb_awipev-co2_server/ny-alesund/data/NRT_data/"
if (Sys.getenv("LOGNAME") == "samir") path = "../../pCloud\ Sync/exp168_AWIPEV-CO2/fb_awipev-co2_server/ny-alesund/data/NRT_data/"
# if (system('echo "$USER"') == "awipev") {
#   setwd("/home/awipev/ny-alesund/") #to run on server
#   path = "data/NRT_data/"
# }

# sur serveur
#setwd("/home/awipev/ny-alesund/") #to run on server
#path = "data/NRT_data/"

####Set environmental variables####
Sys.setenv(TZ="UTC")
# ##Provide in this section the parameters to be downloaded
# #*********************************
# #Use the following aggregation parameters
# agg_time = "MINUTE" #SECOND, MINUTE, HOUR, DAY, MONTH, YEAR
# #Calculate the following statistical values. 
# agg_fun_1 = "MEAN" #MEDIAN
# agg_fun_2 = "STDDEV"
# agg_fun_3 = "N"
# #*********************************
# 
# #### Download current data ####
# # Generally data from yesterday
# # Create end_date (data until yesterday 23:59:59) and start_date (last data from previous data minute).
# 
# # start_date = Open the last "year" file (minute fomat) and take the last line date - 1 day. like that we avoid NA to interpolate Sprim2beamZ (pCO2) later.
# #list_last_year <- list.files(path  = path), pattern = "*all_nydata_minute.*")
# #list_last_year <- list_last_year[length(list_last_year)]
# # start_date <- (end_date - (days_back *(3600*24)))
# # start_date <- ymd_hms("2015-07-25 00:00:00")
# # start_date <- ymd_hms("2018-01-01 00:00:00")
# selected_data_minute <- readRDS(file = paste0(path, "all_nydata_minute.rds"))
# start_date <- ymd_hms(selected_data_minute$datetime[nrow(selected_data_minute)-1]) - days(1)
# startdate <- format(start_date, "%Y-%m-%dT%H:%M:%S") 
# 
# #end_date <- ymd_hms("2017-12-31 23:59:59") 
# #end_date <- ymd_hms("2020-02-15 23:59:59") 
# # days_back <- 2
# end_date <- ymd_hms(paste0(Sys.Date(), " 00:00:00 UTC"))
# enddate <- format(end_date,"%Y-%m-%dT%H:%M:%S")
# 
# #test jpg
# start_date <- ymd_hms("2016-01-01 00:00:00")
# startdate <- format(start_date,"%Y-%m-%dT%H:%M:%S")
# end_date <- ymd_hms("2016-12-31 23:59:59")
# enddate <- format(end_date,"%Y-%m-%dT%H:%M:%S")
# 
# # if enddate - startdate < 1 d one skips everything until the end of this script
# if (end_date-start_date <= days(1)) {
#   stop()
#   }
# 
# if(agg_time=="MINUTE"){
#   aggregate_string=paste0("&aggregate=",agg_time)
# } else {
#   aggregate_string=paste0("&aggregate=",agg_time,"&aggregateFunctions=",agg_fun_1,"&aggregateFunctions=",agg_fun_2,"&aggregateFunctions=",agg_fun_3)
# }
# code <- paste0("https://dashboard.awi.de/data-xxl/rest/data?beginDate=",startdate,"&endDate=",enddate,"&format=text/tab-separated-values",aggregate_string,
#                "&sensors=station:svluwobs:fb_731101:sbe45_awi_0403:salinity",
#                "&sensors=station:svluwobs:fb_731101:sbe45_awi_0403:temperature",
#                "&sensors=station:svluwobs:svluw2:ctd_183:conductivity_awi_01:salinity", 
#                "&sensors=station:svluwobs:svluw2:ctd_181:conductivity_awi_02:salinity", 
#                "&sensors=station:svluwobs:svluw2:ctd_578:conductivity_awi_03:salinity",
#                "&sensors=station:svluwobs:svluw2:ctd_964:conductivity_awi_04:salinity",
#                "&sensors=station:svluwobs:svluw2:ctd_awi_964:salinity_004",
#                "&sensors=station:svluwobs:svluw2:ctd_103:conductivity_awi_01:salinity",
#                "&sensors=station:svluwobs:svluw2:ctd_103:pressure_awi_01:pressure",
#                "&sensors=station:svluwobs:svluw2:ctd_181:pressure_awi_02:pressure",
#                "&sensors=station:svluwobs:svluw2:ctd_183:pressure_awi_01:pressure",
#                "&sensors=station:svluwobs:svluw2:ctd_578:pressure_awi_03:depth",
#                "&sensors=station:svluwobs:svluw2:ctd_964:pressure_awi_04:depth",
#                "&sensors=station:svluwobs:svluw2:ctd_awi_964:pressure_002",
#                "&sensors=station:svluwobs:fb_731101:hydrofia_awi_0317001:ph",
#                "&sensors=station:svluwobs:fb_731101:hydrofia_awi_0317001:total_alcalinity",
#                "&sensors=station:svluwobs:fb_731101:hydrofia_awi_0317001:invalid_salinity",
#                "&sensors=station:svluwobs:fb_731101:hydrofia_awi_0317001:invalid_ph",
#                "&sensors=station:svluwobs:fb_731101:hydrofia_awi_0317001:invalid_ta",
#                "&sensors=station:svluwobs:fb_731101:hydrofia_awi_1215000:ph",
#                "&sensors=station:svluwobs:fb_731101:hydrofia_awi_1215000:total_alcalinity",
#                "&sensors=station:svluwobs:fb_731101:hydrofia_awi_1215000:invalid_salinity",
#                "&sensors=station:svluwobs:fb_731101:hydrofia_awi_1215000:invalid_ph",
#                "&sensors=station:svluwobs:fb_731101:hydrofia_awi_1215000:invalid_ta",
#                "&sensors=station:svluwobs:svluw2:sbe38_awi_0657:temperature",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_007:ph_internal",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_007:ph_external",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_007:voltage_internal",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_007:voltage_external",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_007:ph_temperature",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_007:internal_relative_humidity",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_1005:ph_internal",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_1005:ph_external",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_1005:volt_internal",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_1005:volt_external",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_1005:ph_temperature",
#                "&sensors=station:svluwobs:svluw2:seafet_obsvlfr_1005:internal_relative_humidity",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:zero",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:signal_proc",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:signal_raw",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:signal_ref",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:flush",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:p_in",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:p_ndir",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:t_gas",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:pco2_corr",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:pco2_corr_flush",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0215_obsvlfr_01:pco2_corr_zero",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:zero",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:signal_proc",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:signal_raw",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:signal_ref",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:flush",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:p_in",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:p_ndir",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:t_gas",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:pco2_corr",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:pco2_corr_flush",
#                "&sensors=station:svluwobs:fb_731101:co2ft_0515_obsvlfr_01:pco2_corr_zero",
#                "&sensors=station:svluwobs:fb_731101:durafet_obsvlfr_01:hw_ph",
#                "&sensors=station:svluwobs:fb_731101:durafet_obsvlfr_01:hw_temperature",
#                "&sensors=station:svluwobs:svluw2:par_awi_401:par",
#                "&sensors=station:svluwobs:svluw2:par_awi_493:par",
#                "&sensors=station:svluwobs:fb_731101:par_awi_495:par",
#                "&sensors=station:svluwobs:fb_731101:turbidity_awi_01:turbidity",
#                "&sensors=station:svluwobs:svluw2:ctd_183:temperature_awi_01:temperature",
#                "&sensors=station:svluwobs:svluw2:ctd_181:temperature_awi_02:temperature",
#                "&sensors=station:svluwobs:svluw2:ctd_578:temperature_awi_03:temperature",
#                "&sensors=station:svluwobs:svluw2:ctd_964:temperature_awi_04:temperature",
#                "&sensors=station:svluwobs:svluw2:ctd_awi_964:temperature_002",
#                "&sensors=station:svluwobs:svluw2:ctd_103:temperature_awi_01:temperature"
#                )
# 
# data <- data.table::fread(code, encoding = "UTF-8", showProgress	= TRUE)
# colnames(data) <- c("datetime", "sal_fb", "temp_fb", "sal_insitu_183", "sal_insitu_181", "sal_insitu_578", "sal_insitu_964", "sal_insitu_964b","sal_insitu_103", "pressure_insitu_103", "pressure_insitu_181" ,"pressure_insitu_183", "pressure_insitu_578", "pressure_insitu_964" ,"pressure_insitu_964b" ,"pH_AT_0317", "AT_0317", "InvSal_0317", "InvpH_0317",  "InvAT_0317",  "pH_AT_1215", "AT_1215", "InvSal_1215", "InvpH_1215",  "InvAT_1215","temp_insitu_11m", "phINT_007","phEXT_007","voltINT_007","voltEXT_007", "T_seaF_007", "Humidity_007","phINT_1005","phEXT_1005","voltINT_1005","voltEXT_1005", "T_seaF_1005", "Humidity_1005", "State_Zero_0215", "Signal_Proc_0215", "Signal_Raw_0215", "Signal_Ref_0215", "State_Flush_0215", "P_In_0215", "P_NDIR_0215", "T_Gas_0215", "PCO2_Corr_0215", "PCO2_Corr_Flush_0215","PCO2_Corr_Zero_0215","State_Zero_0515", "Signal_Proc_0515", "Signal_Raw_0515", "Signal_Ref_0515", "State_Flush_0515", "P_In_0515", "P_NDIR_0515", "T_Gas_0515", "PCO2_Corr_0515", "PCO2_Corr_Flush_0515","PCO2_Corr_Zero_0515", "HW_pH1", "HW_Temperature1","par_insitu_profile", "par_insitu_10m", "par_air", "turb_fb", "temp_insitu_183", "temp_insitu_181", "temp_insitu_578", "temp_insitu_964", "temp_insitu_964b","temp_insitu_103" )
# data$datetime <- ymd_hms(data$datetime)
# 
# data2 <- data # just a backup
# # create tsibble and fill gaps
# data <- data %>%
#   as_tsibble(key = NULL, index = datetime) %>%
#   fill_gaps()
# 
# 
# # Create instrument column as flag
# data <- data %>%
#   dplyr::mutate( pco2_inst = ifelse(datetime >= "2015-07-19 00:00:00" & datetime <= "2016-02-23 12:00:00", "0215", 
#                                ifelse(datetime >= "2016-02-23 23:00:00" & datetime <= "2017-02-04 23:00:00", "0515" ,
#                                ifelse(datetime >= "2017-02-09 00:00:00" & datetime <= "2018-02-09 00:00:00", "0215" ,
#                                 ifelse(datetime >= "2018-04-14 00:00:00" & datetime <= "2018-10-31 00:00:00", "0515" , 
#                                 ifelse(datetime >= "2018-10-31 15:00:00" & datetime <= "2019-09-03 12:00:00", "0215" ,
#                                 ifelse(datetime >= "2019-09-03 17:00:00" & datetime <= "2099-12-02 23:59:59", "0515" ,NA )))))),
#                  
#                  seafet_inst = ifelse(datetime >= "2017-08-24 12:00:00" & datetime <= "2018-04-17 12:00:00", "1005", 
#                                ifelse(datetime >= "2018-04-17 12:00:00" & datetime <= "2099-12-02 23:59:59", "007" ,NA )),
#                  
#                  ta_inst = ifelse(datetime >= "2016-02-26 00:00:00" & datetime <= "2017-03-21 12:00:00", "1215", 
#                           ifelse(datetime >= "2018-01-08 12:55:00" & datetime <= "2018-06-20 00:00:00", "0317",
#                            ifelse(datetime >= "2018-07-31 00:00:00" & datetime <= "2018-10-30 18:00:00", "1215",
#                            ifelse(datetime >= "2018-10-30 18:00:00" & datetime <= "2099-12-02 23:59:59", "0317" ,NA ))))
#                  )
# 
# ########### Binding different insitu salinity in one column ########### 
# data <- data %>%
#   dplyr::mutate(sal_insitu_ctd = ifelse(!is.na(sal_insitu_183), sal_insitu_183,
#                            ifelse(!is.na(sal_insitu_181), sal_insitu_181,
#                            ifelse(!is.na(sal_insitu_578), sal_insitu_578, 
#                             ifelse(!is.na(sal_insitu_964b), sal_insitu_964b,
#                             ifelse(!is.na(sal_insitu_103), sal_insitu_103, 
#                           ifelse(!is.na(sal_insitu_964), sal_insitu_964,NA)))))))
# 
# ########### Binding different insitu pressure in one column ########### 
# data <- data %>%
#   dplyr::mutate(pressure_insitu_ctd = ifelse(!is.na(pressure_insitu_183), pressure_insitu_183,
#                                   ifelse(!is.na(pressure_insitu_181), pressure_insitu_181,
#                                   ifelse(!is.na(pressure_insitu_578), pressure_insitu_578, 
#                                   ifelse(!is.na(pressure_insitu_964b), pressure_insitu_964b,
#                                   ifelse(!is.na(pressure_insitu_103), pressure_insitu_103, 
#                                   ifelse(!is.na(pressure_insitu_964), pressure_insitu_964,NA)))))))
# 
# ########### Binding different insitu temp in one column ########### 
# data <- data %>%
#   dplyr::mutate(temp_insitu_ctd = ifelse(!is.na(temp_insitu_183), temp_insitu_183,
#                                         ifelse(!is.na(temp_insitu_181), temp_insitu_181,
#                                         ifelse(!is.na(temp_insitu_578), temp_insitu_578, 
#                                         ifelse(!is.na(temp_insitu_964b), temp_insitu_964b,
#                                         ifelse(!is.na(temp_insitu_103), temp_insitu_103, 
#                                         ifelse(!is.na(temp_insitu_964), temp_insitu_964,NA)))))))
#                 
# ########### Correction pCO2 Contros ########### 
# # Bind different pCO2 sensors (column with S/N) in the same column (without S/N): 0215 + 0515
# data <- data %>%
#   dplyr::mutate(State_Zero=  ifelse(pco2_inst == "0215", State_Zero_0215,
#                              ifelse(pco2_inst == "0515", State_Zero_0515,NA)),
#                 Signal_Proc=ifelse(pco2_inst == "0215", Signal_Proc_0215,
#                              ifelse(pco2_inst == "0515", Signal_Proc_0515,NA)),
#                 Signal_Raw=ifelse(pco2_inst == "0215", Signal_Raw_0215,
#                              ifelse(pco2_inst == "0515", Signal_Raw_0515,NA)),
#                 Signal_Ref=  ifelse(pco2_inst == "0215", Signal_Ref_0215,
#                              ifelse(pco2_inst == "0515", Signal_Ref_0515,NA)),
#                 State_Flush= ifelse(pco2_inst == "0215", State_Flush_0215,
#                              ifelse(pco2_inst == "0515", State_Flush_0515,NA)),
#                 P_In=        ifelse(pco2_inst == "0215", P_In_0215,
#                              ifelse(pco2_inst == "0515", P_In_0515,NA)),
#                 P_NDIR=      ifelse(pco2_inst == "0215", P_NDIR_0215,
#                              ifelse(pco2_inst == "0515", P_NDIR_0515,NA)),
#                 T_Gas=       ifelse(pco2_inst == "0215", T_Gas_0215,
#                              ifelse(pco2_inst == "0515", T_Gas_0515,NA)),
#                 PCO2_Corr=   ifelse(pco2_inst == "0215", PCO2_Corr_0215,
#                              ifelse(pco2_inst == "0515", PCO2_Corr_0515,NA)),
#                 PCO2_Corr_Flush= ifelse(pco2_inst == "0215", PCO2_Corr_Flush_0215,
#                                  ifelse(pco2_inst == "0515", PCO2_Corr_Flush_0515,NA)),
#                 PCO2_Corr_Zero= ifelse(pco2_inst == "0215", PCO2_Corr_Zero_0215,
#                                 ifelse(pco2_inst == "0515", PCO2_Corr_Zero_0515,NA)))
# 
#  # Data processing for pCO2 HydroC CO2 Contros in Ny-Alesund.
#  # Documentation received by Steffen Assmann on the 2016-09-15/19 and 
#  # stored on /fb_doc/Calibration/pCO2_#0215_#0515
#  # Data from the documentation is stored on 
#  # awipev/ny_alesund/data/Calibration_pCO2/Data_Processing_sheet_pCO2.txt
#  
#  # Adding manualy data into Data_Processing_sheet_pCO2 file.
#  # Open the data calibration sheet and convert the dates. 
# 
#  data_process <- read_excel(paste0(path, "Data_Processing_sheet_pCO2.xlsx"), col_types = c("text","text","text","text", "date","date", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "date", "date", "numeric",  "date","numeric","numeric","numeric","numeric","numeric","numeric","numeric","numeric","numeric","numeric","numeric"))
#  # data_process$DateCalibration <- dmy(data_process$DateCalibration)
#  # data_process$DateCalibrationPost <- dmy(data_process$DateCalibrationPost)
#  # data_process$DateDelivery <- dmy(data_process$DateDelivery)
#  # data_process$StartDeployment <- ymd_hms(data_process$StartDeployment)
#  # data_process$EndDeployment <- ymd_hms(data_process$EndDeployment)
#  # Adding the PeriodDeplpCO2 column to z first.
#  # Adding the others parameters according to the Contros formula PDF
#  # Adding the new period ech time we receive the pCO2 sensor from the calibration
#  data <- data %>%
#    dplyr::mutate(PeriodDeplpCO2 = ifelse(datetime >= "2015-07-23 00:00:00" & datetime <= "2016-02-23 22:00:00", 1, 
#                                   ifelse(datetime >= "2016-02-23 23:00:00" & datetime <= "2017-02-04 23:00:00", 2 ,
#                                   ifelse(datetime >= "2017-02-09 00:00:00" & datetime <= "2018-02-09 00:00:00", 3 ,
#                                   ifelse(datetime >= "2018-04-14 00:00:00" & datetime <= "2018-10-31 00:00:00", 4 , 
#                                   ifelse(datetime >= "2018-10-31 15:00:00" & datetime <= "2019-09-03 12:00:00", 5 ,
#                                   ifelse(datetime >= "2019-09-03 17:00:00" & datetime <= "2099-12-02 23:59:59", 6 ,NA )))))))
#                  
# # Adding the fTsensor, F, P0, T0, k1, k2,k3 (Pre calibration)  + F_Post, P0_Post...(Post calibration) columns to z 
# data <- left_join(data,data_process%>%dplyr::select(PeriodDeplpCO2,T0,P0,F, fTsensor,k1,k2,k3, T0_post, P0_post, F_post, fTsensor_post, k1_post,  k2_post, k3_post), by = "PeriodDeplpCO2")
# 
# data <- data %>%
#   dplyr::mutate(Signal_RawZ = ifelse(State_Zero == 1 ,Signal_Raw, NA),
#                 Signal_RefZ = ifelse(State_Zero == 1 ,Signal_Ref, NA),
#                 Signal_ProcZ = ifelse(State_Zero == 1 ,Signal_Proc, NA),
#                 S2beam = Signal_Raw / Signal_Ref,
#                 S2beamZ = Signal_RawZ / Signal_RefZ,
#                 Sprim2beam = S2beam * fTsensor,
#                 Sprim2beamZ = S2beamZ * fTsensor)
# 
# # We remove the 3rd value of Sprim2beamZ during the zeroing (at 00:03:00 and 12:03:00)
# # We keep in Sprim2beamZ the 2nd value of the zeroing (at 00:02:00 and 12:02:00) when it exists 
# # if it does not, we keep the 1st value (at 00:01:00 and 12:01:00) of the zeroing 
# # see Steffen's email on the 2016-12-13 11:11
# data$Time <- strftime(data$datetime, "%H:%M:%S")
# data$Sprim2beamZ[which(data$Time == "00:02:00" & !is.na(data$Sprim2beamZ)) - 1] <- NA
# data$Sprim2beamZ[which(data$Time == "12:02:00" & !is.na(data$Sprim2beamZ)) - 1] <- NA
# #z$Sprim2beamZ[which(z$Time == "00:03:00" | z$Time == "12:03:00")] <- NA
# data$Sprim2beamZ[which(data$Time != "00:02:00" & data$Time != "12:02:00" & data$Time != "12:01:00" & data$Time != "00:01:00") ] <- NA
# 
# # We interpolate Sprim2beamZ and we convert it from "list" to "dataframe"
# # because approx returns to a list.
# # data$Sprim2beamZ_interp <- NULL
# data$Sprim2beamZ_interp <- as.data.frame(approx(x = data$datetime, y = data$Sprim2beamZ ,xout = data$datetime, rule=2))[,2]
# # We remove interpolated data that matche a zeroing / flush period
# data <- data %>%
#   dplyr::mutate(Sprim2beamZ_interp = ifelse( State_Zero == 1 | State_Flush == 1, NA, Sprim2beamZ_interp)
#   )
# 
# ########### pCO2 SPAN DRIFT CORRECTION
# # To calculate the drift-corrected polynomial coefficients from the pre and post calibration
# # Calculate the new k1 k2 k3
# # Extract the first and last S'2beamZ of each periode of deployment.
# # the s dataframe needs to be created again with the new pco2 period when the periode will be known.
# 
# 
# # s <- ddply(data[,c("datetime","PeriodDeplpCO2","Sprim2beamZ_interp")], .(PeriodDeplpCO2), function(x) x[c(1, nrow(x)), ])
# # write.table(s,file= paste0(path, "fb_data/NRT_data/" ),  sep=",", dec=".")
# 
# s <- read.table(file= paste0(path, "SpreambeamZ_extraction.csv"), header = TRUE, dec = ".", sep=",")
# #s <- s[-c(nrow(s), nrow(s)-1),]
# #s$datetime <- ymd_hms(s$datetime)
# #ss <- ddply(data[,c("datetime","PeriodDeplpCO2","Sprim2beamZ_interp")], .(PeriodDeplpCO2), function(x) x[c(1, nrow(x)), ])
# #s <- rbind(s, ss)
# #write.table(s,file= paste0(path, "SpreambeamZ_extraction.csv" ),  sep=",", dec=".", row.names = F)
# 
# data <- data %>%
#   dplyr::mutate(k1t = ifelse(PeriodDeplpCO2 == 1, k1 + ((s[1,3] - Sprim2beamZ_interp) / (s[1,3]  - s[2,3] )) * k1_post,
#                       ifelse(PeriodDeplpCO2 == 2, k1 + ((s[3,3] - Sprim2beamZ_interp) / (s[3,3]  - s[4,3] )) * k1_post,
#                       ifelse(PeriodDeplpCO2 == 3, k1 + ((s[5,3] - Sprim2beamZ_interp) / (s[5,3]  - s[6,3] )) * k1_post, 
#                       ifelse(PeriodDeplpCO2 == 4, k1 + ((s[7,3] - Sprim2beamZ_interp) / (s[7,3]  - s[8,3] )) * k1_post,
#                       ifelse(PeriodDeplpCO2 == 5, k1 + ((s[9,3] - Sprim2beamZ_interp) / (s[9,3]  - s[10,3] )) * k1_post,
#                       ifelse(PeriodDeplpCO2 == 6, k1 + ((s[11,3] - Sprim2beamZ_interp) / (s[11,3]  - s[12,3] )) * k1_post,NA)
#                                                   )))))) %>%
#   dplyr::mutate(k2t = ifelse(PeriodDeplpCO2 == 1, k2 + ((s[1,3] - Sprim2beamZ_interp) / (s[1,3]  - s[2,3] )) * k2_post,
#                       ifelse(PeriodDeplpCO2 == 2, k2 + ((s[3,3] - Sprim2beamZ_interp) / (s[3,3]  - s[4,3] )) * k2_post,
#                       ifelse(PeriodDeplpCO2 == 3, k2 + ((s[5,3] - Sprim2beamZ_interp) / (s[5,3]  - s[6,3] )) * k2_post, 
#                       ifelse(PeriodDeplpCO2 == 4, k2 + ((s[7,3] - Sprim2beamZ_interp) / (s[7,3]  - s[8,3] )) * k2_post, 
#                       ifelse(PeriodDeplpCO2 == 5, k2 + ((s[9,3] - Sprim2beamZ_interp) / (s[9,3]  - s[10,3] )) * k2_post,
#                       ifelse(PeriodDeplpCO2 == 6, k2 + ((s[11,3] - Sprim2beamZ_interp) / (s[11,3]  - s[12,3] )) * k2_post,NA)
#                                                   )))))) %>%
#   dplyr::mutate(k3t = ifelse(PeriodDeplpCO2 == 1, k3 + ((s[1,3] - Sprim2beamZ_interp) / (s[1,3]  - s[2,3] )) * k3_post,
#                       ifelse(PeriodDeplpCO2 == 2, k3 + ((s[3,3] - Sprim2beamZ_interp) / (s[3,3]  - s[4,3] )) * k3_post,
#                       ifelse(PeriodDeplpCO2 == 3, k3 + ((s[5,3] - Sprim2beamZ_interp) / (s[5,3]  - s[6,3] )) * k3_post, 
#                       ifelse(PeriodDeplpCO2 == 4, k3 + ((s[7,3] - Sprim2beamZ_interp) / (s[7,3]  - s[8,3] )) * k3_post, 
#                       ifelse(PeriodDeplpCO2 == 5, k3 + ((s[9,3] - Sprim2beamZ_interp) / (s[9,3]  - s[10,3] )) * k3_post,
#                       ifelse(PeriodDeplpCO2 == 6, k3 + ((s[11,3] - Sprim2beamZ_interp) / (s[11,3]  - s[12,3] )) * k3_post, NA)
#                                                   ))))))
# 
# data <- data %>%
#   dplyr::mutate(k1t = ifelse(!is.na(k1t), k1t, k1)) %>%
#   dplyr::mutate(k2t = ifelse(!is.na(k2t), k2t, k2)) %>%
#   dplyr::mutate(k3t = ifelse(!is.na(k3t), k3t, k3)) 
# 
# # Continue to calculate parameters and FINAL PCO2 CORRECTED (PCO2_corr_contros)
# data <- data %>%
#   dplyr::mutate(SprimDCt = Sprim2beam / Sprim2beamZ_interp,
#                 Sproct  = F*(1-SprimDCt),
#                 xco2wet = (k3t*Sproct^3 + k2t*Sproct^2 + k1t*Sproct)* (P0*(T_Gas + 273.15))/(T0 * P_NDIR),
#                 PCO2_corr_contros = xco2wet * (P_In / 1013.25)
#   )

tmp <- as_tibble(
  readRDS(file = paste0(path, "all_parameters_nydata_minute.rds"))
)
data <- tmp
```

```{r First cleaning, echo=FALSE}
##### First cleaning
# Argo qflags: 1 is good data, 4 is bad data

#### Argo impossible date test
data <- data %>%
  dplyr::mutate(dt_qf = ifelse(
    year(data$datetime) < 2010 | year(data$datetime) > 2022 |
      month(data$datetime) < 1 | month(data$datetime) > 12 |
      day(data$datetime) < 1 | day(data$datetime) > 31 |
      hour(data$datetime) < 0 | hour(data$datetime) > 23 |
      minute(data$datetime) < 0 | minute(data$datetime) > 59,
    4, 1)) %>%
  dplyr::filter(dt_qf == 1) # removes rows with wrong dates


## pCO2 
# Argo Global Range Test. If QF = 4 replace value by NA
# Removing outliers due to acid flush in the FB at 12:00 and 00:00 
# PCO2_Corr = Raw data from the sensor
# PCO2_corr_contros = Final corrected data from Contros "data processing document"

data <- data %>% 
  dplyr::mutate(
    PCO2_Corr_qf = ifelse(
      State_Zero >= 1 | State_Flush >= 1 |
        PCO2_Corr < 100 | PCO2_Corr > 450 |
        Time >= "00:00:00" & Time <= "01:30:00" |
        Time >= "12:00:00" & Time <= "13:00:00" |
      datetime >= "2017-03-10 08:00:00" &
        datetime < "2017-03-21 20:00:00",
      4,
      1
    ),
    PCO2_Corr = ifelse(PCO2_Corr_qf == 4 , NA, PCO2_Corr),
    PCO2_corr_contros_qf = ifelse(
      State_Zero >= 1 | State_Flush >= 1 |
        PCO2_corr_contros < 100 | PCO2_corr_contros > 450 |
        Time >= "00:00:00" & Time <= "01:30:00" |
        Time >= "12:00:00" & Time <= "13:00:00" |
      datetime >= "2017-03-10 08:00:00" &
        datetime < "2017-03-21 20:00:00",
      4,
      1
    ),
    PCO2_corr_contros = ifelse(PCO2_corr_contros_qf == 4 , NA, PCO2_corr_contros)
    )
## seaFET
data <- data %>%
  dplyr::mutate(phINT = ifelse(phINT >7.5  & phINT <8.5, phINT, NA), 
                phEXT = ifelse(phEXT >7.5  & phEXT <8.5, phEXT, NA))

```

# {.tabset .tabset-fade .tabset-pills}

## Infos 

One reads data from the NRT and then focus on pCO2:

* Argo impossible date text

* Argo Global Range Test: eliminate pCO2 < 100 and > 450, between 00:00 and 01:30, between 12:00 to 13:00, and during periods we know the system behaved poorly.

* Use of despike:
    + The type of reference time series to be used in the detection of spikes is **median**. The first step is to linearly interpolate across any gaps (spots where x==NA), using approx() with rule=2. The second step is to pass this through runmed() to get a running median spanning k elements. The result of these two steps is the "reference" time-series. Then, the standard deviation of the difference between x and the reference is calculated. Any x values that differ from the reference by more than n times this standard deviation are considered to be spikes. If replace="reference", the spike values are replaced with the reference, and the resultant time series is returned. If replace="NA", the spikes are replaced with NA, and that result is returned.
    + all combinations of the following n and k values:
        * n <- c(0.01, 0.1, 1, 2) # number of times sd
        * k <- c(5, 31, 121, 1441, $1440*4+1$, $1440*6+1$) # time window in min

There are `r length(data$PCO2_corr_contros)` data in this 2016 file. `r sum(!is.na(data$PCO2_corr_contros))` are not NAs (the first 2 months or so have NAs). 

TO DO in RMD: 
(ph seafet dans Rmd)
(pH durafet dans Rmd)

```{r clean, echo=FALSE, results = 'asis'}
clean <- function(var=var) {
  n <- c(0.1, 0.5, 1, 2) # number of times sd
  k <-
    c(5, 31, 121, 1441, 1440 * 4 + 1, 1440 * 6 + 1) # time window to calculate median in min
  grid <- as_tibble(expand.grid(n = n, k = k)) %>%
    dplyr::arrange(n)
  res <- tibble(datetime = data$datetime)
  NAs <- NULL
  param <- NULL
  #summ <- tibble(.rows = 20)
  for (i in 1:nrow(grid)) {
    #  i <- 1
    tmp <- oce::despike(
      x = var,
      reference = "median",
      n = grid$n[i],
      k = grid$k[i],
      min = NA,
      max = NA,
      replace = "NA"
    )
    new_col_name <- paste0("n", grid$n[i], "k", grid$k[i])
    res <- dplyr::mutate(res,!!new_col_name := tmp)
    param <- append(param, new_col_name) # list of new columns
    NAs <-
      append(NAs, sum(is.na(tmp))) # number of NAs in each cleaned column
  }
  nNAs <- tibble(param = factor(param, levels = param), NAs) %>%
    dplyr::mutate(additional_NAs = NAs - sum(is.na(var)))
return(list(res=res, nNAs = nNAs))
}
``` 

```{r plot despike, include=FALSE}
plot_despike <- function(data = res, var=var){ # car is the variable name, a text
d <- res %>%
  select(datetime, starts_with("n0.1")) %>%
  pivot_longer(-datetime, names_to = "params", values_to = "pCO2") %>%
  dplyr::mutate(params = factor(params)) %>%
  dplyr::mutate(params = factor(params, levels=levels(params)[c(4, 3, 1, 2, 5, 6)]))
plt_n0.1 <- d %>%
  ggplot() +
  geom_point(aes(x=datetime, y=pCO2, col=params), na.rm= TRUE, size=0.25) +
  facet_wrap(vars(params), ncol = 1) +
  theme_bw()
ggsave(filename = paste0(var,"_plt_n0.1.png"), plt_n0.1, dpi=80)
print(plt_n0.1)

d <- res %>%
  select(datetime, starts_with("n0.5")) %>%
  pivot_longer(-datetime, names_to = "params", values_to = "pCO2") %>%
  dplyr::mutate(params = factor(params)) %>%
  dplyr::mutate(params = factor(params, levels=levels(params)[c(4, 3, 1, 2, 5, 6)]))
plt_n0.5 <- d %>%
  ggplot() +
  geom_point(aes(x=datetime, y=pCO2, col=params), na.rm= TRUE, size=0.25) +
  facet_wrap(vars(params), ncol = 1) +
  theme_bw()
ggsave(filename = paste0(var,"_plt_n0.5.png"), plt_n0.5, dpi=80)
print(plt_n0.5)

d <- res %>%
  select(datetime, starts_with("n1")) %>%
  pivot_longer(-datetime, names_to = "params", values_to = "pCO2") %>%
  dplyr::mutate(params = factor(params)) %>%
  dplyr::mutate(params = factor(params, levels=levels(params)[c(4, 3, 1, 2, 5, 6)]))
plt_n1 <- d %>%
  ggplot() +
  geom_point(aes(x=datetime, y=pCO2, col=params), na.rm= TRUE, size=0.25) +
  facet_wrap(vars(params), ncol = 1) +
  theme_bw()
ggsave(filename = paste0(var,"_plt_n1.png"), plt_n1, dpi=80)
print(plt_n1)

d <- res %>%
  select(datetime, starts_with("n2")) %>%
  pivot_longer(-datetime, names_to = "params", values_to = "pCO2") %>%
  dplyr::mutate(params = factor(params)) %>%
  dplyr::mutate(params = factor(params, levels=levels(params)[c(4, 3, 1, 2, 5, 6)]))
plt_n2 <- d %>%
  ggplot() +
  geom_point(aes(x=datetime, y=pCO2, col=params), na.rm= TRUE, size=0.25) +
  facet_wrap(vars(params), ncol = 1) +
  theme_bw()
ggsave(filename = paste0(var,"_plt_n2.png"), plt_n2, dpi=80)
print(plt_n2)
}
```

```{r hour format, include=FALSE}
agg_hour <- function(data = res, var=var){
d <- as_tsibble(res %>%
                  dplyr::select(datetime, n0.5k5761, n0.5k8641, n1k5761, n1k8641))
d_hour <- d %>%
  group_by_key() %>%
  index_by(hour = ~ lubridate::floor_date(., "1 hour")) %>% # monthly aggregates
  summarise(
    n0.5k5761h = mean(n0.5k5761, na.rm = TRUE),
    n0.5k8641h = mean(n0.5k8641, na.rm = TRUE),
    n1k5761h = mean(n1k5761, na.rm = TRUE),
    n1k8641h = mean(n1k8641, na.rm = TRUE)
  )
summary_d_hour <- summary(d_hour)
return(list(d_hour=d_hour, summary_d_hour = summary_d_hour))
}
```

```{r dygraphs, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike <- function(var=var){
  d_hour_xts <- d_hour %>%
  as.xts(order.by = d_hour$hour)
dygraph(d_hour_xts,
        group = "",
        main = var,
        ylab = "pco2") %>%
  dySeries(
    "n0.5k5761h",
    label = "n0.5k5761h",
    color = "black",
    strokeWidth = 0,
    pointSize = 2
  ) %>%
  dySeries(
    "n0.5k8641h",
    label = "n0.5k8641h",
    color = "red",
    strokeWidth = 0,
    pointSize = 2
  ) %>%
  dySeries(
    "n1k5761h",
    label = "n1k5761h",
    color = "blue",
    strokeWidth = 0,
    pointSize = 2
  ) %>%
  dySeries(
    "n1k8641h",
    label = "n1k8641h",
    color = "orange",
    strokeWidth = 0,
    pointSize = 2
  ) %>%
  dyLimit(0, color = "black", strokePattern = "dashed") %>%
  dyHighlight(
    highlightCircleSize = 8,
    highlightSeriesBackgroundAlpha = 0.2,
    hideOnMouseOut = TRUE
  ) %>%
  dyOptions(
    useDataTimezone = TRUE,
    drawGrid = TRUE,
    drawPoints = TRUE,
    strokeWidth = 0,
    digitsAfterDecimal = 5
  ) %>%
  dyRangeSelector(height = 30)
}
```


n0.5k5761	and n0.5k8641	remove a lot of data points (> 300,000), many of them seem legitimate. n1k5761	and n1k8641 remove much less data points (124000 to 134000) and therefore seem more appropriate. Although very subjective, it seems that n1k8641 cuts some spikes, which appears unnecessary. One settles for n1k5761.


## *p*CO~2~

### PCO2_corr_contros

#### Cleanning 
```{r clean PCO2_corr_contros, echo=FALSE, results = 'asis'}
tmp <- clean(data$PCO2_corr_contros)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike PCO2_corr_contros, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$PCO2_corr_contros")
``` 

#### Hour format
```{r hour format PCO2_corr_contros, include=FALSE}
tmp <- agg_hour(data = res, var = "data$PCO2_corr_contros")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs PCO2_corr_contros, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$PCO2_corr_contros")
```

## Salinities

### sal_fb

#### Cleanning 
```{r clean sal_fb, echo=FALSE, results = 'asis'}
tmp <- clean(data$sal_fb)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike sal_fb, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$sal_fb")
``` 

#### Hour format
```{r hour format sal_fb, include=FALSE}
tmp <- agg_hour(data = res, var = "data$sal_fb")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs sal_fb, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$sal_fb")
```

### sal_insitu_ctd

#### Cleanning 
```{r clean sal_insitu_ctd, echo=FALSE, results = 'asis'}
tmp <- clean(data$sal_insitu_ctd)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike sal_insitu_ctd, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$sal_insitu_ctd")
``` 

#### Hour format
```{r hour format sal_insitu_ctd, include=FALSE}
tmp <- agg_hour(data = res, var = "data$sal_insitu_ctd")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs sal_insitu_ctd, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$sal_insitu_ctd")
```

## Temperatures

### temp_fb

#### Cleanning 
```{r clean temp_fb, echo=FALSE, results = 'asis'}
tmp <- clean(data$temp_fb)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike temp_fb, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$temp_fb")
``` 

#### Hour format
```{r hour format temp_fb, include=FALSE}
tmp <- agg_hour(data = res, var = "data$temp_fb")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs temp_fb, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$temp_fb")
```

### HW_Temperature1 (durafet)

#### Cleanning  
```{r clean HW_Temperature1, echo=FALSE, results = 'asis'}
tmp <- clean(data$HW_Temperature1)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike HW_Temperature1, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$HW_Temperature1")
``` 

#### Hour format
```{r hour format HW_Temperature1, include=FALSE}
tmp <- agg_hour(data = res, var = "data$HW_Temperature1")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs HW_Temperature1, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$HW_Temperature1")
```

### temp_insitu_11m

#### Cleanning 
```{r clean temp_insitu_11m, echo=FALSE, results = 'asis'}
tmp <- clean(data$temp_insitu_11m)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike temp_insitu_11m, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$temp_insitu_11m")
``` 

#### Hour format
```{r hour format temp_insitu_11m, include=FALSE}
tmp <- agg_hour(data = res, var = "data$temp_insitu_11m")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs temp_insitu_11m, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$temp_insitu_11m")
```

### temp_insitu_ctd

#### Cleanning 
```{r clean temp_insitu_ctd, echo=FALSE, results = 'asis'}
tmp <- clean(data$temp_insitu_ctd)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike temp_insitu_ctd, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$temp_insitu_ctd")
``` 

#### Hour format
```{r hour format temp_insitu_ctd, include=FALSE}
tmp <- agg_hour(data = res, var = "data$temp_insitu_ctd")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs temp_insitu_ctd, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$temp_insitu_ctd")
```

## PAR

### par_insitu_profile

#### Cleanning 
```{r clean par_insitu_profile, echo=FALSE, results = 'asis'}
tmp <- clean(data$par_insitu_profile)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike par_insitu_profile, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$par_insitu_profile")
``` 

#### Hour format
```{r hour format par_insitu_profile, include=FALSE}
tmp <- agg_hour(data = res, var = "data$par_insitu_profile")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs par_insitu_profile, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$par_insitu_profile")
```

### par_insitu_10m

#### Cleanning 
```{r clean par_insitu_10m, echo=FALSE, results = 'asis'}
tmp <- clean(data$par_insitu_10m)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike par_insitu_10m, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$par_insitu_10m")
``` 

#### Hour format
```{r hour format par_insitu_10m, include=FALSE}
tmp <- agg_hour(data = res, var = "data$par_insitu_10m")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs par_insitu_10m, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$par_insitu_10m")
```

### par_air

#### Cleanning 
```{r clean par_air, echo=FALSE, results = 'asis'}
tmp <- clean(data$par_air)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike par_air, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$par_air")
``` 

#### Hour format
```{r hour format par_air, include=FALSE}
tmp <- agg_hour(data = res, var = "data$par_air")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs par_air, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$par_air")
```

## Turbidity

### turb_fb

#### Cleanning 
```{r clean turb_fb, echo=FALSE, results = 'asis'}
tmp <- clean(data$turb_fb)
res <- tmp[[1]]
nNAs <- tmp[[2]]
knitr::kable(nNAs, caption = "NAs added by the despike treatment") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
``` 

#### Plot despike 
```{r plot despike turb_fb, echo=FALSE, results = 'asis'}
plot_despike(data = res, var = "data$turb_fb")
``` 

#### Hour format
```{r hour format turb_fb, include=FALSE}
tmp <- agg_hour(data = res, var = "data$turb_fb")
d_hour <- tmp[[1]]
summary_d_hour <- tmp[[2]]
knitr::kable(summary_d_hour, caption = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Dygraphs
```{r dygraphs turb_fb, , echo=FALSE, warning=FALSE, out.width= "100%"}
dygraphs_despike(var="data$turb_fb")
```





